<?php
require_once __DIR__ . '/intern/intern-fs/admin/php-include/error_settings.inc';
require_once __DIR__ . '/intern/intern-fs/admin/php-include/office_hours.inc';

// max. rows to show in preview for office hours during break
const FP_MAX_ROWS = 10;
?>

<article class="module short"><div class="module-content">
<h2>Aktuelle Präsenzzeiten</h2>

<?php
$dt_current = new DateTime();
$semester_info = semester_info($dt_current);
$semester = $semester_info['during_semester'];
$db = mysql_db_connect();

if ($semester) {
	echo <<<HTML
	<div class="subhead" style="margin: 1em 0;">Vorlesungszeit</div>
HTML;
	// 1 (Monday) to 7 (Sunday)
	$day_of_week = $dt_current->format('N');
	// for Saturday and Sunday: Show Monday
	if ($day_of_week >= 6) {
		$days_to_monday = 8 - $day_of_week;
		// set DateTime to next Monday
		$dt_current->add(new DateInterval("P{$days_to_monday}D"));
	}
	// 'EEEE' →  full day of week in PHP intl; see IntlDateFormatter
	// https://ssl.icu-project.org/apiref/icu4c/classSimpleDateFormat.html#details
	$day_of_week_show = datefmt_format_object($dt_current, 'EEEE', 'de_DE');
	$sql = 'SELECT * FROM praesenzplan ORDER BY zeit ASC;';
	$query = $db->query($sql);
	echo <<<HTML
	<table style="width: 100%;">
		<tr>
			<th scope="col" style="width: 20%;">Zeit</th>
			<th scope="col">$day_of_week_show</th>
		</tr>
HTML;
	while ($row = $query->fetch()) {
		$time = $row['zeit'];
		echo <<<HTML
		<tr>
			<td>$time</td>
			<td>{$row[mb_strtolower($day_of_week_show)]}</td>
		</tr>
HTML;
	}
	echo '</table>';
}
else {
	echo <<<HTML
	<div class="subhead" style="margin: 1em 0;">Vorlesungsfreie Zeit</div>
HTML;

	$sql = 'SELECT Anzahl FROM fepraesenzplan WHERE ID = 0;';
	$max = $db->query($sql)->fetch()[0];

	$sql = 'SELECT * FROM fepraesenzplan ORDER BY ID ASC;';
	$query = $db->query($sql);
	echo <<<HTML
	<table style="width: 100%;">
		<tr>
			<th scope="col" style="width: 30%;">Datum</th>
			<th scope="col" style="width: 20%;">Zeit</th>
			<th scope="col">Name</th>
		</tr>
HTML;
	$row_num = 0;
	$display_num = 0;
	while (($row = $query->fetch()) && $row_num < $max && $display_num < FP_MAX_ROWS) {
		$row_num++;
		// DateTime for yesterday: subtract 1 day
		$dt_yesterday = clone $dt_current;
		$dt_yesterday->sub(new DateInterval('P1D'));
		// don't display entries in the past
		$dt_row_date = date_create($row['Datum']);
		if ($dt_row_date < $dt_yesterday) {
			continue;
		}
		$display_num++;
		$date_show = $row['Datum'];
		// get localized day of week from date field (cf. above)
		//$day_of_week_show = datefmt_format_object($dt_row_date, 'EEEE', 'de_DE');
		// convert times DateTime objects and format
		$dt_row_starttime = date_create($row['starttime']);
		$starttime_show = $dt_row_starttime->format('H:i');
		echo <<<HTML
		<tr>
			<td>$date_show</td>
			<td>$starttime_show</td>
			<td>{$row['name']}</td>
		</tr>
HTML;
	}
	echo '</table>';
}

mysql_db_close($db);
?>
<p><a class="int" href="/Physik.FSPHYS/termine/">Vollständiger Präsenzplan</a></p>
</div></article>

